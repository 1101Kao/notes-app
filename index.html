<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Notes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family:"Meiryo UI", sans-serif; margin:0; }
  body.light { background:#f0f4f8; color:#2a3a50; }
  body.dark  { background:#0f1115; color:#e8edf5; }

  /* ===== サイドバーしまう ===== */
  .sidebar-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 2400; /* サイドバー (2500) より下に */
    display: none;
    pointer-events: none; /* デフォルトではクリック無効 */
  }
  .sidebar-overlay.show {
    display: block;
    pointer-events: auto; /* show のときだけ有効化 */
  }

  /* ===== ヘッダー ===== */
  .topbar {
    background:#4a90e2; color:#fff;
    padding:8px 12px; position:sticky; top:0; z-index:2000;
  }
  .topbar-inner { display:flex; justify-content:space-between; align-items:center; }
  .topbar-title { font-weight:bold; }
  .topbar-actions { display:flex; flex-wrap:nowrap; gap:4px; overflow-x:auto; }
  .btn {
    padding:4px 8px; cursor:pointer; border:none; border-radius:6px;
    background:#ffffff; color:#2a3a50; font-size:12px; white-space:nowrap;
    font-family:"Meiryo UI",sans-serif;
  }
  .btn:hover { opacity:.9; }
  body.dark .btn { background:#2a3140; color:#e8edf5; }
  .btn-primary { background:#4a90e2; color:#fff; }
  .btn-danger  { background:#e24a4a; color:#fff; }
  .btn-cancel  { background:#fff; border:1px solid #999; color:#333; }

  /* ===== 情報＆検索 ===== */
  #infoPanel { display:none; font-size:12px; margin:8px 16px; color:#556; }
  #filterPanel { margin:8px 16px; }
  #q {
    width:300px;
    max-width:60%;
    padding:6px; border:1px solid #cfd8e3; border-radius:6px;
    font-size:13px; font-family:"Meiryo UI",sans-serif;
  }
  #q::placeholder { color:#999; font-style:italic; }

  /* ===== レイアウト ===== */
  .container { display:flex; }
  .sidebar {
    width:200px; border-right:1px solid #d8e1eb; padding:14px;
    background: linear-gradient(180deg,#ffffff,#f7f9fc);
  }
  body.dark .sidebar { background:#1c1f28; border-color:#2a3140; }
  .sidebar h4 { margin:0 0 10px; font-size:13px; color:#6b7a90; }
  .sidebar ul { list-style:none; padding:0; margin:0; }
  .sidebar li {
    cursor:pointer; margin:6px 0; padding:6px 8px; border-radius:6px;
    display:flex; justify-content:space-between; align-items:center; font-size:13px;
  }
  .sidebar li.active { background:#4a90e2; color:#fff; }
  .sidebar .del-btn, .sidebar .edit-btn {
    font-size: 12px; margin-left:6px; cursor:pointer; opacity:0.6;
  }
  .sidebar .del-btn:hover { color:#e24a4a; opacity:1; }
  .sidebar .edit-btn:hover { color:#4a90e2; opacity:1; }

  .cat-input { display:flex; gap:4px; margin-top:8px; }
  .cat-input input { flex:1; padding:4px; font-size:12px; font-family:"Meiryo UI",sans-serif; }
  .cat-input button { flex:0 0 auto; padding:4px 6px; font-size:12px; }

  .main { flex:1; padding:18px; }

  /* ===== ノートカード ===== */
  .note {
    border:1px solid #e3e8ef; background:#fff; border-radius:10px;
    padding:12px; margin-bottom:12px; cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,.06);
    font-size:13px; white-space:pre-wrap; word-wrap:break-word;
    display:flex; flex-direction:column; gap:4px;
    font-family:"Meiryo UI",sans-serif;
  }
  .note-header { display:flex; align-items:center; gap:6px; }
  .note h3 { margin:0; font-size:15px; flex:1; }
  .note small { color:#6b7a90; font-size:12px; }
  body.dark .note { background:#141925; border-color:#2a3140; color:#e8edf5; box-shadow:0 2px 8px rgba(0,0,0,.25); }

  /* ===== PC用モーダル ===== */
  #dlg {
    display:none; position:absolute;
    width:600px; max-width:95%;
    background:#fff; color:#2a3a50; border:1px solid #d0d7e2; border-radius:10px;
    box-shadow:0 16px 32px rgba(0,0,0,.3); z-index:1000;
    font-size:13px; font-family:"Meiryo UI",sans-serif;
  }
  body.dark #dlg { background:#141925; color:#e8edf5; border-color:#2a3140; }
  #dlgHeader {
    padding:10px 14px; background:#4a90e2; color:#fff; border-radius:10px 10px 0 0;
    cursor:move; user-select:none; font-weight:bold;
  }
  #dlg .content { padding:20px; }
  #dlg input, #dlg textarea, #dlg select {
    display:block;
    width:100%; max-width:100%;
    margin-bottom:10px; padding:8px; border:1px solid #cfd8e3; border-radius:6px;
    font-size:13px; font-family:"Meiryo UI",sans-serif; box-sizing:border-box;
  }
  .modal-footer { text-align:right; }

  /* ===== export設定用モーダル ===== */
 #exportDlg {
  display:none;
  position:absolute;
  width:400px; max-width:90%;
  background:#fff; color:#2a3a50;
  border:1px solid #d0d7e2; border-radius:10px;
  box-shadow:0 16px 32px rgba(0,0,0,.3);
  z-index:1500;
  font-size:13px; font-family:"Meiryo UI",sans-serif;
}

#exportDlgHeader {
  padding:10px 14px;
  background:#4a90e2; color:#fff;
  border-radius:10px 10px 0 0;
  font-weight:bold;
}

#exportDlg .content {
  padding:16px;
}

#exportDlg .modal-footer {
  text-align:right;
  margin-top:10px;
}

 /* ===== モバイル用エディタ ===== */
.mobile-editor {
  position: fixed;
  top: 0;
  left: 100%;
  width: 100%;
  height: 100%;
  background: #fff;
  transition: left 0.3s ease;
  z-index: 3000;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}

.mobile-editor.show {
  left: 0;
}

/* ヘッダー（青帯） */
.mobile-editor .editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #4a90e2;
  color: #fff;
  font-weight: bold;
}

.mobile-editor .editor-header button {
  background: #fff;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
}

/* 本文エリア */
.mobile-editor .editor-content {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #fff;
  box-sizing: border-box;
}

/* 入力欄（共通） */
.mobile-editor .editor-content input,
.mobile-editor .editor-content textarea,
.mobile-editor .editor-content select {
  display: block;
  width: 100%;
  max-width: 100%;
  margin-bottom: 12px;
  padding: 10px;
  border: 1px solid #cfd8e3;
  border-radius: 6px;
  font-size: 14px;
  box-sizing: border-box;
}

/* 日付入力欄だけ特別処理（iOS Safariの独自スタイルを無効化） */
.mobile-editor .editor-content input[type="date"] {
  -webkit-appearance: none;
  appearance: none;
  background: #fff;
  color: #333;
}

  /* ===== 検索ボックスの幅調整 ===== */
  @media screen and (max-width:600px) {
    #q {
      width:100%;
      max-width:100%;
      display:block;
      margin:0 auto;
    }
  }

  /* ===== モバイルでカテゴリ操作ボタンを大きく ===== */
  @media screen and (max-width:600px) {
    .sidebar .edit-btn,
    .sidebar .del-btn {
      font-size:20px;
      padding:1px;
    }
  }

  /* ===== モバイルレイアウト調整 ===== */
  @media screen and (max-width:600px) {
    .sidebar {
      position: fixed;
      left: -100%;
      top: 0; bottom: 0;
      width: 80%; max-width: 280px;
      background: #fff;
      transition: left 0.3s ease;
      z-index: 2500;
      box-shadow: 2px 0 8px rgba(0,0,0,.2);
    }
    .sidebar.show { left: 0; }

    .menu-toggle {
      display:inline-block;
      font-size:30px;
      margin-right:10px;
      cursor:pointer;
    }

    .note {
      border: none;
      border-bottom: 1px solid #ddd;
      border-radius: 0;
      padding: 12px;
      box-shadow: none;
      background: transparent;
    }
    .note h3 { font-size: 16px; margin: 0 0 4px; font-weight: bold; }
    .note small { display: block; color: #888; margin-bottom: 4px; }
    .note p {
      font-size: 13px; color:#444; margin:0;
      white-space:pre-wrap; /* ← 修正済み */
      overflow:hidden; text-overflow:ellipsis;
    }

    /* ===== モバイル新規ボタン ===== */
    .fab {
      position: fixed;
      bottom: 16px; right: 16px;
      width: 56px; height: 56px;
      border-radius: 50%; border: none;
      background: #2a3a50; color: #fff;
      font-size: 28px; font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      cursor: pointer; transition: background 0.3s;
      z-index: 3000;
    }
    .fab:hover { background: #a90e2; }
  }

  /* ===== はみ出し防止 ===== */
  .note, .mobile-editor, .editor-content,
  input, textarea, select {
    box-sizing: border-box;
    max-width: 100%;
  }

.select-all {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 10px;
  font-size: 13px;
  font-weight: bold;
  color: #4a90e2;
  cursor: pointer;
  user-select: none;
}

.select-all input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: #4a90e2; /* ブルー系で統一 */
  cursor: pointer;
}
  
</style>
</head>
<body class="light">
<!-- ===== Topbar ===== -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="topbar-title">
  <span class="menu-toggle" onclick="toggleCats()">≡</span>Notes
</div>
    <div class="topbar-actions">
      <button class="btn" onclick="toggleInfo()">info</button>
      <button class="btn" onclick="toggleTheme()">tm</button>
      <button class="btn" onclick="exportNotes()">ex</button>
      <button class="btn" onclick="openExportDialog()">ex+</button>
      <input type="file" id="importFile" style="display:none" onchange="importNotes(event)">
      <button class="btn" onclick="document.getElementById('importFile').click()">in</button>
      <button class="btn btn-danger" onclick="deleteSelected()">del</button>
      <button class="btn btn-primary" onclick="openEditor(null); debugCheck()">＋</button>
    </div>
  </div>
</div>

<!-- 情報＆検索 -->
<div id="infoPanel">「＋」でノート作成できます。チェックをつけて「del」で一括削除できます。</div>
<div id="filterPanel"><input type="text" id="q" placeholder="検索したいワード" onkeyup="render()"></div>

<!-- ===== 2カラム ===== -->
<div class="container">
  <div class="sidebar">
    <h4>カテゴリ</h4>
    <ul id="catList"></ul>
    <div class="cat-input">
      <input type="text" id="newCat" placeholder="新しいカテゴリ">
      <button onclick="addCategory()">＋</button>
    </div>
  </div>
  <div class="main">
    <!-- 全選択用 -->
    <div class="select-all">
    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
  </div>
    <div id="list"></div>
  </div>
</div>

<!-- ===== PC用モーダル ===== -->
<div id="dlg">
  <div id="dlgHeader">ノート編集</div>
  <div class="content">
    <input type="date" id="fDate">
    <select id="fCat"></select>
    <input type="text" id="fTitle" placeholder="タイトル">
    <textarea id="fNotes" placeholder="本文" rows="6"></textarea>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="deleteNote()">削除</button>
      <button class="btn btn-cancel" onclick="closeEditor()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveNote()">保存</button>
    </div>
  </div>
</div>
<!-- ===== export設定用モーダル ===== -->
 <!-- ===== Export モーダル ===== -->
<div id="exportDlg">
  <div id="exportDlgHeader">エクスポート設定</div>
  <div class="content">
    <label>
      <input type="checkbox" id="expSelected"> チェック付きノートのみ
    </label>
    <br><br>
    <label>開始日: <input type="date" id="expStart"></label><br>
    <label>終了日: <input type="date" id="expEnd"></label>
    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeExportDialog()">キャンセル</button>
      <button class="btn btn-primary" onclick="doExport()">エクスポート</button>
    </div>
  </div>
</div>



  
<!-- ===== モバイル用エディタ ===== -->
<div class="mobile-editor" id="mobileEditor">
  <div class="editor-header">
    <span>ノート編集</span>
    <button onclick="closeMobileEditor()">閉じる</button>
  </div>
  <div class="editor-content">
    <input type="date" id="mDate">
    <select id="mCat"></select>
    <input type="text" id="mTitle" placeholder="タイトル">
    <textarea id="mNotes" placeholder="本文" rows="8"></textarea>

    <!-- 保存ボタンをここに追加 -->
    <button class="btn btn-primary" onclick="saveMobileNote()">保存</button>
  </div>
</div>

<!-- モバイル新規ボタン -->
<button class="fab" onclick="onFabClick()">＋</button>

<!-- ===== サイドバーしまう用 ===== -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleCats()"></div>
 
 <script>
var notes=[],current=null,categories=[],theme=(function(){try{return localStorage.getItem("theme")||"light";}catch(e){return"light";}})(),currentCategory="all",selectedIds=new Set();

/* ===== ストレージ ===== */
function storageGet(k){try{return localStorage.getItem(k);}catch(e){return null;}}
function storageSet(k,v){try{localStorage.setItem(k,v);}catch(e){}}
function loadNotes(){var d=storageGet("notes");if(d){try{notes=JSON.parse(d)||[];}catch(e){notes=[];}}}
function saveNotes(){storageSet("notes",JSON.stringify(notes));}
function loadCategories(){var d=storageGet("categories");if(d){try{categories=JSON.parse(d)||["daily","weekly","kb"];}catch(e){categories=["daily","weekly","kb"];}}else{categories=["daily","weekly","kb"];} }
function saveCategories(){storageSet("categories",JSON.stringify(categories));}

/* ===== レンダリング ===== */
function render(){
  // レンダリング開始時に全選択リセット
  const master = document.getElementById("selectAll");
  if(master) master.checked = false;

  var list=document.getElementById('list');list.innerHTML='';
  var q=(document.getElementById('q').value||'').toLowerCase();

  // ★ ピン留めを上に
  let sorted=[...notes].sort((a,b)=>{
    if(a.pinned && !b.pinned) return -1;
    if(!a.pinned && b.pinned) return 1;
    return new Date(b.date)-new Date(a.date);
  });

  sorted.forEach(n=>{
    if(currentCategory!=="all"&&n.cat!==currentCategory)return;
    var t=(n.title||"").toLowerCase(),body=(n.notes||"").toLowerCase();
    if(q&&t.indexOf(q)===-1&&body.indexOf(q)===-1)return;

    var div=document.createElement('div');div.className='note';
    var header=document.createElement('div');header.className='note-header';

    var chk=document.createElement('input');chk.type='checkbox';chk.checked=selectedIds.has(n.id);
    chk.onchange = function(e){
  toggleSelect(n.id, chk);
  e.stopPropagation();
};
div.__noteId = n.id;  // ★追加

    header.appendChild(chk);

    var pin=document.createElement('span');
    pin.textContent=n.pinned?"★":"☆";
    pin.style.cursor="pointer";pin.style.color=n.pinned?"#f39c12":"#aaa";
    pin.onclick=function(e){e.stopPropagation();n.pinned=!n.pinned;saveNotes();render();};
    header.appendChild(pin);

    var title=document.createElement('h3');title.textContent=n.title||"(無題)";
    header.appendChild(title);div.appendChild(header);

    var meta=document.createElement('small');meta.textContent=n.date+"（"+n.cat+"）";div.appendChild(meta);
    var p=document.createElement('p');p.textContent=n.notes||"";div.appendChild(p);

    div.ondblclick=function(){openEditorById(n.id);};
    div.onclick=function(e){if(e.target.tagName!=="INPUT"&&e.target!==pin){toggleSelect(n.id,chk);chk.checked=selectedIds.has(n.id);}};
    list.appendChild(div);
  });
  renderCategories();
}
function renderCategories(){
  categories.sort((a,b)=>a.localeCompare(b,"ja"));
  var list=document.getElementById("catList");list.innerHTML="";
  var allLi=document.createElement("li");allLi.textContent="すべて";if(currentCategory==="all")allLi.classList.add("active");
  allLi.onclick=function(){setCategory("all");};list.appendChild(allLi);
  categories.forEach(cat=>{
    var li=document.createElement("li");if(cat===currentCategory)li.classList.add("active");
    var span=document.createElement("span");span.textContent=cat;span.style.flex="1";li.appendChild(span);
    var edit=document.createElement("span");edit.textContent="✎";edit.className="edit-btn";edit.onclick=function(e){e.stopPropagation();editCategory(cat);};li.appendChild(edit);
    var del=document.createElement("span");del.textContent="×";del.className="del-btn";del.onclick=function(e){e.stopPropagation();if(confirm(cat+" を削除しますか？")){categories=categories.filter(c=>c!==cat);saveCategories();renderCategories();}};li.appendChild(del);
    li.onclick=function(){setCategory(cat);};list.appendChild(li);
  });
  var sel=document.getElementById("fCat");sel.innerHTML="";
  categories.forEach(cat=>{var o=document.createElement("option");o.value=cat;o.textContent=cat;sel.appendChild(o);});
  var msel=document.getElementById("mCat");msel.innerHTML="";
  categories.forEach(cat=>{var o=document.createElement("option");o.value=cat;o.textContent=cat;msel.appendChild(o);});
}

/* ===== サイドバー toggle ===== */
function toggleCats(){
  const sidebar=document.querySelector(".sidebar");
  const overlay=document.getElementById("sidebarOverlay");
  const isOpen=sidebar.classList.toggle("show");
  if(isOpen){overlay.classList.add("show");}else{overlay.classList.remove("show");}
}

/* ===== カテゴリ操作 ===== */
function setCategory(cat){
  currentCategory = cat;
  selectedIds.clear();                  // ← 選択解除
  const master = document.getElementById("selectAll");
  if(master) master.checked = false;    // ← 全選択チェックも外す
  render();
}

function addCategory(){
  var v=document.getElementById("newCat").value.trim();
  if(!v)return;
  if(categories.includes(v)){alert("既に存在します");return;}
  categories.push(v);saveCategories();renderCategories();
  document.getElementById("newCat").value="";
}
function editCategory(oldName){
  var newName=prompt("新しいカテゴリ名:",oldName);
  if(!newName||newName.trim()==="")return;
  newName=newName.trim();
  if(categories.includes(newName)){alert("既に存在します");return;}
  categories=categories.map(c=>c===oldName?newName:c);
  notes.forEach(n=>{if(n.cat===oldName)n.cat=newName;});
  saveCategories();saveNotes();render();
}

/* ===== 選択削除 ===== */
function toggleSelect(id,chk){if(selectedIds.has(id))selectedIds.delete(id);else selectedIds.add(id);}
function deleteSelected(){if(selectedIds.size===0){alert("削除対象がありません");return;}
  if(confirm("選択したノートを削除しますか？")){
    notes=notes.filter(n=>!selectedIds.has(n.id));selectedIds.clear();saveNotes();render();
  }}

/* ===== エディタ ===== */
function openEditor(n){
  current=n||{id:Date.now(),date:todayStr(),cat:categories[0]||"daily",title:'',notes:''};
  if(window.innerWidth<=600){
    document.getElementById('mDate').value=current.date;
    document.getElementById('mCat').value=current.cat;
    document.getElementById('mTitle').value=current.title;
    document.getElementById('mNotes').value=current.notes;
    document.getElementById('mobileEditor').classList.add('show');
  } else {
    document.getElementById('fDate').value=current.date;
    document.getElementById('fCat').value=current.cat;
    document.getElementById('fTitle').value=current.title;
    document.getElementById('fNotes').value=current.notes;
    document.getElementById('dlg').style.display='block';
    centerDialog();
  }
}
function openEditorById(id){var n=notes.find(x=>x.id===id);if(n)openEditor(n);}
function closeEditor(){document.getElementById('dlg').style.display='none';}
function closeMobileEditor(){document.getElementById('mobileEditor').classList.remove('show');}
function saveNote(){
  current.date=document.getElementById('fDate').value;
  current.cat=document.getElementById('fCat').value;
  current.title=document.getElementById('fTitle').value;
  current.notes=document.getElementById('fNotes').value;
  var i=notes.findIndex(x=>x.id===current.id);
  if(i>=0)notes[i]=current;else notes.unshift(current);
  saveNotes();render();closeEditor();
}
function saveMobileNote(){
  if(!current){current={id:Date.now()};notes.unshift(current);}
  current.date=document.getElementById('mDate').value;
  current.cat=document.getElementById('mCat').value;
  current.title=document.getElementById('mTitle').value;
  current.notes=document.getElementById('mNotes').value;
  var i=notes.findIndex(x=>x.id===current.id);
  if(i>=0)notes[i]=current;else notes.unshift(current);
  saveNotes();render();closeMobileEditor();
}

/* ===== Ex/Import ===== */
function exportNotes(){var data=JSON.stringify(notes,null,2);
  var blob=new Blob([data],{type:"application/json"});
  var url=URL.createObjectURL(blob);var a=document.createElement("a");
  var d=new Date(),fn="notes-"+d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2)+".json";
  a.href=url;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}
function importNotes(e){
  var file=e.target.files[0]; if(!file) return;
  var reader=new FileReader();
  reader.onload=function(evt){
    try {
      var imported=JSON.parse(evt.target.result);
      if(imported&&imported.length){
        imported.forEach(n=>{if(notes.some(x=>x.id===n.id)){n.id=Date.now()+Math.floor(Math.random()*10000);}});
        if(confirm("既存のノートに追加しますか？\nキャンセル = 中止")){
          notes=notes.concat(imported);saveNotes();render();alert("インポート完了！");
        }
      }
    } catch(err){alert("インポート失敗: "+err.message);}
  };
  reader.readAsText(file);
}

/* ===== 情報・テーマ ===== */
function toggleInfo(){var p=document.getElementById('infoPanel');p.style.display=(p.style.display==='block')?'none':'block';}
function toggleTheme(){theme=(theme==="light")?"dark":"light";document.body.className=theme;storageSet("theme",theme);}

/* ===== ユーティリティ ===== */
function todayStr(){var d=new Date();return d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2);}
function init(){document.body.className=theme;loadNotes();loadCategories();render();}
init();

/* ===== モーダルドラッグ ===== */
(function(){
  var dlg=document.getElementById("dlg"),header=document.getElementById("dlgHeader");
  var startX=0,startY=0,startLeft=0,startTop=0,dragging=false;
  function getClientWidth(){return document.documentElement.clientWidth||document.body.clientWidth;}
  function getScrollTop(){return document.documentElement.scrollTop||document.body.scrollTop;}
  function centerDialog(){
    var w=getClientWidth();var dw=dlg.offsetWidth||520;
    var left=Math.max(10,Math.floor((w-dw)/2));
    var top=getScrollTop()+80;
    dlg.style.left=left+"px";dlg.style.top=top+"px";
  }
  window.centerDialog=centerDialog;
  header.onmousedown=function(e){
    dragging=true;startX=e.clientX;startY=e.clientY;
    startLeft=dlg.offsetLeft;startTop=dlg.offsetTop;
    document.onmousemove=function(e2){
      if(!dragging)return;
      var dx=e2.clientX-startX;var dy=e2.clientY-startY;
      dlg.style.left=(startLeft+dx)+"px";dlg.style.top=(startTop+dy)+"px";
    };
    document.onmouseup=function(){dragging=false;document.onmousemove=null;document.onmouseup=null;};
  };
  window.onresize=function(){if(dlg.style.display==='block'&&!dragging){centerDialog();}};
})();
// ===== FAB ボタン動作 =====
function onFabClick() {
  const me = document.getElementById("mobileEditor");
  if (me.classList.contains("show")) {
    // すでにエディタ開いてる場合 → 未保存チェック
    const curTitle = document.getElementById("mTitle").value;
    const curNotes = document.getElementById("mNotes").value;
    const curDate  = document.getElementById("mDate").value;
    const curCat   = document.getElementById("mCat").value;

    // 保存されてる内容と比較（current が今のノート）
    if (current &&
        (curTitle !== current.title ||
         curNotes !== current.notes ||
         curDate  !== current.date ||
         curCat   !== current.cat)) {

      if (!confirm("変更が保存されていません。新規ノートを作成しますか？")) {
        return; // キャンセルしたら何もしない
      }
    }
  }

  // 新規作成モードへ
  openMobileEditor();
}

// ===== モバイルエディタ =====
let mobileDirty = false; // 入力内容に変更があったかどうか

function openMobileEditor(note = null){
  current = note || {
    id: Date.now(),
    date: todayStr(),
    cat: categories[0] || "daily",
    title: '',
    notes: '',
    pinned: false
  };
  document.getElementById('mDate').value  = current.date;
  document.getElementById('mCat').value   = current.cat;
  document.getElementById('mTitle').value = current.title;
  document.getElementById('mNotes').value = current.notes;

  document.getElementById('mobileEditor').classList.add('show');
  mobileDirty = false; // 開いた直後は未変更
  attachMobileChangeWatch();
}

function attachMobileChangeWatch(){
  ["mDate","mCat","mTitle","mNotes"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.oninput = () => { mobileDirty = true; };
    }
  });
}

function saveMobileNote(){
  if(!current){
    current = {id: Date.now()};
    notes.unshift(current);
  }
  current.date  = document.getElementById('mDate').value;
  current.cat   = document.getElementById('mCat').value;
  current.title = document.getElementById('mTitle').value;
  current.notes = document.getElementById('mNotes').value;

  const i = notes.findIndex(x=>x.id===current.id);
  if(i>=0) notes[i] = current; else notes.unshift(current);

  saveNotes();
  render();
  mobileDirty = false; // 保存したので未変更状態
}

function closeMobileEditor(){
  if(mobileDirty){
    if(!confirm("変更が保存されていません。閉じますか？")) return;
  }
  document.getElementById('mobileEditor').classList.remove('show');
  mobileDirty = false;
}
   
// ===== 全選択処理 =====
function toggleSelectAll() {
  const master = document.getElementById("selectAll");
  const list = document.querySelectorAll("#list .note input[type='checkbox']");
  selectedIds.clear();
  list.forEach(chk => {
    chk.checked = master.checked;
    const noteId = chk.closest(".note").__noteId;
    if (master.checked) {
      selectedIds.add(noteId);
    }
  });
}


// ===== 選択したものをexport =====   
/* ===== Export モーダル ===== */
function openExportDialog(){
  document.getElementById("exportDlg").style.display = "block";
}
function closeExportDialog(){
  document.getElementById("exportDlg").style.display = "none";
}

function doExport(){
  let data = notes;

  // チェック付きのみ
  if(document.getElementById("expSelected").checked){
    data = data.filter(n => selectedIds.has(n.id));
  }

  // 日付範囲
  const start = document.getElementById("expStart").value;
  const end   = document.getElementById("expEnd").value;
  if(start){
    data = data.filter(n => new Date(n.date) >= new Date(start));
  }
  if(end){
    data = data.filter(n => new Date(n.date) <= new Date(end));
  }

  if(!data.length){
    alert("条件に合うノートがありません");
    return;
  }

  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  const d    = new Date();
  const fn   = "notes-export-"+d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2)+".json";
  a.href = url; a.download = fn;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);

  closeExportDialog();
}

// ===== エクスポートモーダルドラッグ =====
(function(){
  var dlg = document.getElementById("exportDlg"),
      header = document.getElementById("exportDlgHeader");
  if (!dlg || !header) return;

  var startX=0, startY=0, startLeft=0, startTop=0, dragging=false;
  header.onmousedown=function(e){
    dragging=true;
    startX=e.clientX; startY=e.clientY;
    startLeft=dlg.offsetLeft; startTop=dlg.offsetTop;
    document.onmousemove=function(e2){
      if(!dragging)return;
      var dx=e2.clientX-startX, dy=e2.clientY-startY;
      dlg.style.left=(startLeft+dx)+"px";
      dlg.style.top=(startTop+dy)+"px";
    };
    document.onmouseup=function(){
      dragging=false;
      document.onmousemove=null;
      document.onmouseup=null;
    };
  };
})();

  
</script>
</body>
</html>
